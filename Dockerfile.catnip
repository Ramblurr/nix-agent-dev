FROM docker.io/wandb/catnip:latest

RUN apt-get update && export DEBIAN_FRONTEND=noninteractive \
    && apt-get -y install --no-install-recommends curl xz-utils sudo \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Determinate Nix (as root, with --init none for containers)
# With --init none, only root can run nix commands (no daemon)
RUN curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux \
    --init none \
    --extra-conf "sandbox = false" \
    --no-confirm

ENV PATH="/nix/var/nix/profiles/default/bin:$PATH"

RUN mkdir -p /workspace && chown catnip:catnip /workspace
WORKDIR /workspace

COPY --chown=catnip:catnip . /home/catnip/.config/home-manager

RUN set -ex; \
    mkdir -p /home/catnip/.config/nix; \
    echo "experimental-features = nix-command flakes" > /home/catnip/.config/nix/nix.conf; \
    find /home/catnip/.config; \
    chown -R catnip:catnip /home/catnip/.config

# Pre-build home-manager activation package (as root, since --init none)
# Build from local copy to pick up catnip user config
# Mark directory as safe for git (since we're running as root but directory is owned by catnip)
RUN git config --global --add safe.directory /home/catnip/.config/home-manager \
    && cd /home/catnip/.config/home-manager \
    && nix build --impure --no-write-lock-file --no-link --show-trace \
       ".#homeConfigurations.catnip.activationPackage"

RUN mkdir -p /home/catnip/.local/bin && chown -R catnip:catnip /home/catnip/.local

COPY --chown=catnip:catnip --chmod=755 scripts/home-manager-update /home/catnip/.local/bin/home-manager-update
COPY --chown=catnip:catnip --chmod=755 scripts/dev-env-start /home/catnip/.local/bin/dev-env-start
COPY --chown=catnip:catnip --chmod=755 scripts/dev-env-poststart /home/catnip/.local/bin/dev-env-poststart

COPY --chmod=755 scripts/nix-entrypoint.sh /nix-entrypoint.sh

ENV USER=catnip
ENV CATNIP_USERNAME=catnip
ENV NIX_CONFIG="experimental-features = nix-command flakes"
ENV PATH="/home/catnip/.local/bin:/home/catnip/.nix-profile/bin:/nix/var/nix/profiles/default/bin:$PATH"

ENTRYPOINT ["/nix-entrypoint.sh"]
CMD ["catnip", "serve"]
